<!--
 * @Description: 
 * @Version: Beata1.0
 * @Autor: 【B站&公众号】Rong姐姐好可爱
 * @Date: 2020-09-16 23:20:39
 * @LastEditors: 【B站&公众号】Rong姐姐好可爱
 * @LastEditTime: 2020-09-16 23:52:50
-->
<!--
 * @Description: 
 * @Version: Beata1.0
 * @Autor: 【B站&公众号】Rong姐姐好可爱
 * @Date: 2020-09-16 23:20:39
 * @LastEditors: 【B站&公众号】Rong姐姐好可爱
 * @LastEditTime: 2020-09-16 23:50:42
-->


## ELK基础概念与常用架构整理

> 提到搜索或者全文搜索，elk技术必须占据重要的席位，强如github这样的大公司，在做海量数据搜索的时候，都有用到elk技术，我先前所在的一个小型互联网公司，也用到了elk，甚至做成了公共的平台，每个项目组有日志业务或者其他海量数据业务的时候，只需要简单的写申请，审批过后就能正式在项目中进行接入了..然而我所在的项目组，就很争气，不用他们的，自己结合业务用了三台服务器去搭建了一个elk集群，去处理用户量（千万级）的巨大的日志需求；实际用过之后，就不得不说，这东西做日志查询、做全文搜索，解决大数据量下mysql的索引瓶颈真的是厉害的不得了...这也就促进了我在3月份的时候去接触elk，搭建内测集群了(转眼10月了，才想着回过头来整理...我淦)


就单纯从ELK上来讨论，其实是三个组件的缩写，即：ElasticSearch、Logstash、Kibana，当然结合实际业务，也可以把ELK发展到ELKF，也就是多了一个Filebeat；这里的Filebeat只是众多beat中较为出名、用的最多的一个，还有很多beat可以实现不同文件、类型的日志采集。

### Elasticsearch

> 分布式搜索和分析引擎。具有高可伸缩、高可靠和易管理等特点。基于 Apache Lucene 构建，能对大容量的数据进行接近实时的存储、搜索和分析操作。

### Logstash

> 日志收集器。搜集各种数据源，并对数据进行过滤、分析、格式化等操作，然后存储到 Elasticsearch。

### Kibana

> 数据分析和可视化平台。与 Elasticsearch 配合使用，对其中数据进行搜索、分析、图表展示。

### Filebeat

> 一个轻量级开源日志文件数据搜集器，Filebeat 读取文件内容，发送到 Logstash 进行解析后进入 Elasticsearch，或直接发送到 Elasticsearch 进行集中式存储和分析。

### 架构介绍
基于ELK的使用方式，Logstash 作为日志搜集器，Elasticsearch 进行日志存储，Kibana作为日志呈现，大致以下几种架构。

- 架构一


图中 Logstash 多个的原因是考虑到程序是分布式架构的情况，每台机器都需要部署一个 Logstash，如果确实是单服务器的情况部署一个 Logstash 即可。

前面提到 Logstash 会对数据进行分析、过滤、格式化等操作，这一系列操作对服务器的 CPU 和内存资源的消耗都是比较高的，所以这种架构会影响每台服务器的性能，所以并不推荐采用。

- 架构二



相比于架构一，增加了一个MQ 和 Logstash， Logstash 的输出和输入支持 Kafka、Redis、RabbitMQ 等常见消息队列， MQ 前的 Logstash 只作为日志收集和传输，并不解析和过滤，先将日志加入队列，由 MQ 后面的
Logstash 继续解析和过滤，这样就不至于每台服务器消耗资源都很多。

- 架构三

这种架构是基于架构二简化来的，实际在使用过程中也是可以采取的，日志直接进入 MQ，Logstash 消费 MQ 数据即可。

- 架构四

这种架构在日志数据源和 Logstash（或 Elasticsearch） 中增加了 Beats 。Beats 集合了多种单一用途数据采集器，每款采集器都是以用于转发数据的通用库 libbeat 为基石，beat 所占的系统CPU和内存几乎可以忽略不计，libbeat平台还提供了检测机制，当下游服务器负载高或网络拥堵时，会自动降低发生速率。下面的例子我们使用 Filebeat 来对文件日志的收集，其他的 beat 可以忽略。

架构四相比于架构二，如果将每台服务器上部署的 Logstash 都换成对应的 Beats ，那就是更理想的架构了。

不管怎么样，对于日志解析和过滤的 Logstash 资源消耗还是比较高的，所以如果需要，可以将 Logstash 的部署使用分布式，Elasticsearch 的部署使用集群来强化整个日志系统。